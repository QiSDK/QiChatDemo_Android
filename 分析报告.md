# QiChatDemo Android 应用分析报告

## 1. 项目结构概览
- **根模块**：工程名 `QiChatDemo`，包含宿主应用 `app` 与核心客服 UI 库 `TeneasyChatSDKUI_Android`。
- **宿主应用**：`app` 仅承担入口与简单导航，`MainFragment` 触发客服入口、打开 PDF 示例并跳转到设置页。
- **客服 UI 库**：封装聊天界面、线路探测、文件上传与设置等完整业务逻辑，依赖外部 SDK `com.github.QiSDK:QiChatSDK_Android:1.9.8` 负责 WebSocket 通信。
- **导航**：
  - `app/src/main/res/navigation/my_graph.xml` 将主页与设置页纳入宿主导航。
  - `TeneasyChatSDKUI_Android/src/main/res/navigation/nav_graph.xml` 管理客服模块内部导航，包括入口选择、聊天、PDF/图片/视频查看器和设置页。

## 2. 核心业务流程
1. **应用启动**：`MainActivity` 加载 `MainFragment`（`app/src/main/java/com/teneasy/qldemo/MainFragment.kt`）。
2. **读取配置**：`MainFragment.onCreate` 调用 `Utils().readConfig()`，从 `SharedPreferences` 取出域名、证书、token 等配置。
3. **跳转客服**：点击 “联系客服” → 打开 `KeFuActivity`（`TeneasyChatSDKUI_Android/src/main/java/com/teneasy/chatuisdk/ui/KeFuActivity.kt`）。
4. **线路探测**：`SelectConsultTypeFragment` 读取配置、调用 `LineDetectLib` 挑选可用域名并更新 `Constants.domain`，随后请求咨询列表（`SelectConsultTypeViewModel.queryEntrance()`）。
5. **进入会话**：选中咨询项 → `KeFuFragment`。该 Fragment 同时承担：
   - 初始化 SDK (`ChatLib.init`)，建立 WebSocket 连接。
   - 加载历史消息、自动回复与客服资料（`KeFuViewModel`）。
   - 处理消息发送、回复、引用、文件/视频/图像上传与预览。
   - 监听连接状态并通过 `TimerTask` 实现断线重连逻辑。
6. **设置界面**：`SettingsFragment` 允许修改域名、证书、用户信息等配置并持久化到 `SharedPreferences`。

## 3. 关键模块说明
- **全局配置 (`Constants.kt`)**：集中保存默认域名、证书、商户/用户信息；运行时属性（token、workerId、chatId 等）也存放于此。
- **网络层**：
  - `XHttp2` + Retrofit 接口定义于 `MainApi.java`（身份认证、聊天记录、自动回复、错误上报）。
  - 手写 OkHttp 上传工具 `UploadUtil.kt`、`UploadUtilWithProgress.kt` 并与外部 SDK 上传工具混用。
- **状态管理**：
  - `KeFuViewModel` 提供 LiveData 列表与 UI 状态，负责消息实体构造与自动回复加载。
  - `BaseViewModel` 聚合错误上报逻辑。
- **UI 适配器**：
  - `MessageListAdapter` 根据消息类型渲染文本、图片、视频、文件、自动回复 QA 等多种 Cell。
  - `SelectConsultTypeAdapter` 列出可选咨询类型，并负责跳转聊天界面与触发未读清零。
- **工具类 (`Utils.kt`)**：提供配置读取、键盘/复制控制、时间格式化、视频压缩、Tiff 转换、文件下载等大量静态方法。

## 4. 主要问题与风险
1. **硬编码敏感配置**：
   - 默认域名、证书、商户 ID 等全部硬编码在 `Constants.kt:53-72`；`UploadUtilWithProgress.kt:48-50` 再次写死域名与 token，并直接重写 `Constants.domain`、`Constants.xToken`，存在严重安全隐患与状态串扰。
2. **状态共享混乱**：`Constants` 同时承担“配置 + 运行态”角色，随处读写。`ApplicationExt.kt:34-38` 在 Application 初始化时把 `Constants.domain` 设为 `"https://localhost"` 并注入到 XHttp，全局状态来源不明确。
3. **MVC 失衡/类体积过大**：`KeFuFragment.kt` 超 1100 行，集成权限请求、聊天状态机、消息展示、上传、计时器、导航等全部逻辑，难以维护与测试。
4. **协程/生命周期风险**：`BaseViewModel.kt:65-68` 使用 `GlobalScope.launch` 推迟错误上报，缺乏生命周期感知；`SelectConsultTypeAdapter.kt:36-37` 在 Adapter 内 new ViewModel 并调用网络，脱离 `ViewModelStore` 管理。
5. **多套上传实现**：既有自研 `UploadUtil.kt`、`UploadUtilWithProgress.kt`，又引入 `com.teneasy.sdk.UploadUtil`。逻辑重复、参数不一致，维护成本高且易触发 bug。
6. **代码风格与平台适配**：大量 Kotlin 文件保留 Java 样式 `package ...;`；某些权限申请逻辑（如 `WRITE_EXTERNAL_STORAGE`）在 Android 13+ 已弃用，需更新。
7. **测试与日志缺失**：无单元/仪器测试覆盖聊天状态转换、自动回复、断线重连等关键路径；日志上报依赖手写工具，缺乏统一策略与重试机制。

## 5. 优化与重构建议
1. **配置与安全治理**
   - 将域名、证书、商户/用户默认值迁移到构建变体或远程配置，敏感信息通过 `BuildConfig`、安全存储或加密文件下发。
   - 运行态数据（token、chatId、workerId）改用 `SessionManager`/Repository 管理，通过 `StateFlow` 暴露，避免直接写全局静态字段。

2. **模块拆分**
   - 将 `KeFuFragment` 拆解为：连接/会话管理器、消息列表控制器、媒体处理器、UI Fragment。本地消息渲染可采用 `ListAdapter + DiffUtil`。
   - `SelectConsultTypeAdapter` 去除业务逻辑，把未读清零与导航交给 Fragment 或 ViewModel。

3. **网络与上传统一化**
   - 建立 `ChatRepository`，封装 `XHttp2/Retrofit` 请求与上传逻辑，统一错误处理。可考虑直接包装 SDK 上传回调改为 `suspend` / Flow。
   - 废弃 `UploadUtilWithProgress.kt` 中硬编码逻辑，使用依赖注入方式传入域名/token。

4. **引入现代架构组件**
   - 采用 `ViewModel + viewModelScope`、`Flow`/`LiveData`、`LifecycleOwner`，消除 `GlobalScope` 与 TimerTask 循环，改用 `repeatOnLifecycle` 监听连接状态。
   - 引入 Hilt/Koin 等 DI 框架注入 `ChatLib`、`UserPreferences`、`OkHttpClient` 等依赖。

5. **稳定性与体验**
   - 完善权限处理逻辑，针对 Android 13+ 使用 `READ_MEDIA_*`、动态申请策略。
   - 为断线重连、自动退出、上传失败提供明确 UI 提示与重试选项。

6. **测试与工程实践**
   - 编写针对 `KeFuViewModel` 的单元测试（消息构造、自动回复合并、历史记录拼装）。
   - 在聊天流程关键节点添加 instrumentation 测试，验证导航、上传、媒体浏览行为。
   - 统一代码风格（Kotlin 官方标准、禁用 Java 样式分号），引入 `ktlint`/`detekt`。

## 6. 建议的实施顺序
1. **短期整理**：配置治理、禁用硬编码上传工具、修正 Adapter 创建 ViewModel、删除 `GlobalScope`。
2. **中期重构**：拆分 `KeFuFragment`，建立 Repository + ViewModel 层，统一网络与上传模块，引入 DI。
3. **长期演进**：补充测试体系、灰度发布策略、监控与告警（日志上报、性能监控），持续优化 UI 体验与无障碍支持。

---
本文档基于 `QiChatDemo_Android` 仓库当前代码快照（分析日期：2025-09-17）。随着后续迭代，建议定期复审并更新报告。
